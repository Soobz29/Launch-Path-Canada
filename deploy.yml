name: Build and Deploy to GKE

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          docker build -t soobz/launch-path-canada:${{ github.sha }} .
          docker push soobz/launch-path-canada:${{ github.sha }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v1

      - name: Connect to GKE cluster
        run: |
          gcloud container clusters get-credentials launch-path-cluster --zone northamerica-northeast1-a --project launch-path-canada

      - name: Deploy new image to Kubernetes
        run: |
          kubectl set image deployment/launch-path-canada launch-path-canada=soobz/launch-path-canada:${{ github.sha }}

      - name: Verify deployment

        run: kubectl rollout status deployment/launch-path-canada
        - name: Debug env vars
        run: |
          echo "Supabase URL length: ${#VITE_SUPABASE_URL}"
          echo "Anon key length: ${#VITE_SUPABASE_ANON_KEY}"
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
