name: Build and Deploy to GKE

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image
        run: |
          # Build without baking Supabase keys
          docker build -t soobz/launch-path-canada:${{ github.sha }} .
          docker push soobz/launch-path-canada:${{ github.sha }}

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Install GKE auth plugin
        run: gcloud components install gke-gcloud-auth-plugin --quiet

      - name: Connect to GKE cluster
        run: |
          gcloud container clusters get-credentials launch-path-cluster --zone northamerica-northeast1-a --project launch-path-canada

      - name: Deploy new image to Kubernetes
        run: |
          kubectl set image deployment/launch-path-canada launch-path-canada=soobz/launch-path-canada:${{ github.sha }}

      - name: Verify deployment
        run: kubectl rollout status deployment/launch-path-canada
